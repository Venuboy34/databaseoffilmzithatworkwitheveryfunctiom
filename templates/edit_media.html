<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Media</title>
    <style>
        /* General Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1c1c1e;
            color: #f0f0f0;
            padding: 20px;
            margin: 0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 900px;
            margin: 40px auto;
            background: #2c2c2e;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
        }

        /* Header */
        h1 {
            text-align: center;
            color: #e0e0e0;
            border-bottom: 2px solid #3a3a3c;
            padding-bottom: 15px;
            margin-bottom: 30px;
        }

        /* Form Elements */
        .form-section {
            background: #3a3a3c;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #b0b0b0;
        }

        input[type="text"], input[type="number"], input[type="date"], textarea {
            width: 100%;
            padding: 12px;
            box-sizing: border-box;
            background: #4a4a4c;
            border: 1px solid #555;
            color: #fff;
            border-radius: 6px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, textarea:focus {
            border-color: #6a11cb;
            box-shadow: 0 0 0 2px rgba(106, 17, 203, 0.3);
            outline: none;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Buttons */
        .btn-primary, .btn-secondary {
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 6px;
            transition: transform 0.2s, background-color 0.2s;
            text-transform: uppercase;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%);
            color: #fff;
            width: 100%;
            margin-top: 20px;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }

        .btn-secondary {
            background-color: #555;
            color: #fff;
        }

        .btn-secondary:hover {
            background-color: #666;
            transform: translateY(-2px);
        }

        .remove-btn {
            background: #ff4d4d;
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .remove-btn:hover {
            background: #e60000;
        }

        /* TV Series Specific Styles */
        .season-container {
            border: 1px dashed #555;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            background-color: #2c2c2e;
        }
        
        .episode-container {
            margin-top: 15px;
            padding-left: 20px;
            border-left: 2px solid #6a11cb;
        }

        .episode-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .episode-row input {
            flex-grow: 1;
            min-width: 150px;
        }

        /* Utility */
        .error-message {
            text-align: center;
            color: #ff4d4d;
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 30px;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .success-message {
            background: #4CAF50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        .debug-info {
            background: #ff6b6b;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>✏️ Edit Media</h1>
        
        <div id="loading-error" class="error-message" style="display: none;">
            Error: Cannot load media. Please ensure the ID is valid and the backend is running.
        </div>

        <div id="success-message" class="success-message" style="display: none;"></div>
        <div id="debug-info" class="debug-info"></div>
        
        <form id="edit-media-form">
            <input type="hidden" id="media-id" name="id">
            
            <div class="form-section">
                <h2>Media Details</h2>
                <div class="form-group">
                    <label for="type">Media Type:</label>
                    <input type="text" id="type" name="type" readonly>
                </div>
                <div class="form-group">
                    <label for="title">Title: *</label>
                    <input type="text" id="title" name="title" required>
                </div>
                <div class="form-group">
                    <label for="description">Description:</label>
                    <textarea id="description" name="description" placeholder="Enter description..."></textarea>
                </div>
                <div class="form-group">
                    <label for="thumbnail">Thumbnail URL:</label>
                    <input type="text" id="thumbnail" name="thumbnail" placeholder="https://example.com/poster.jpg">
                </div>
                <div class="form-group">
                    <label for="backdrop">Backdrop Image URL:</label>
                    <input type="text" id="backdrop" name="backdrop" placeholder="https://example.com/backdrop.jpg">
                </div>
                <div class="form-group">
                    <label for="release_date">Release Date:</label>
                    <input type="date" id="release_date" name="release_date">
                </div>
                <div class="form-group">
                    <label for="language">Language:</label>
                    <input type="text" id="language" name="language" placeholder="en">
                </div>
                <div class="form-group">
                    <label for="rating">Rating:</label>
                    <input type="number" step="0.1" id="rating" name="rating" placeholder="7.5" min="0" max="10">
                </div>
                <div class="form-group">
                    <label for="genres">Genres (comma-separated):</label>
                    <input type="text" id="genres" name="genres" placeholder="Action, Drama, Comedy">
                </div>
                <div class="form-group">
                    <label for="cast_members">Cast (JSON):</label>
                    <textarea id="cast_members" name="cast_members" placeholder='[{"name": "Actor Name", "character": "Character Name"}]'></textarea>
                </div>
            </div>
            
            <div id="dynamic-fields"></div>

            <button type="submit" class="btn-primary">Update Media</button>
        </form>
    </div>

    <script>
        const API_BASE_URL = window.location.origin + '/api/media';
        const ADMIN_API_BASE_URL = window.location.origin + '/api/admin';
        const AUTH_HEADER = 'Basic ' + btoa('venura:venura');
        let seasonNumberCounter = 0;

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const mediaId = urlParams.get('id');
            if (!mediaId) {
                document.getElementById('loading-error').style.display = 'block';
                return;
            }
            document.getElementById('media-id').value = mediaId;
            await loadMediaData(mediaId);
        });

        async function loadMediaData(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/${id}`);
                if (!response.ok) {
                    throw new Error('Media not found.');
                }
                const media = await response.json();
                console.log('Loaded media data:', media);
                populateForm(media);
            } catch (err) {
                console.error("Failed to load media:", err);
                document.getElementById('loading-error').style.display = 'block';
                setTimeout(() => {
                     window.location.href = '/admin/search_and_edit';
                }, 3000);
            }
        }

        function populateForm(media) {
            console.log('Populating form with:', media);
            
            // Basic fields
            document.getElementById('type').value = media.type || '';
            document.getElementById('title').value = media.title || '';
            document.getElementById('description').value = media.description || '';
            document.getElementById('thumbnail').value = media.thumbnail || '';
            document.getElementById('backdrop').value = media.backdrop || '';
            document.getElementById('release_date').value = media.release_date || '';
            document.getElementById('language').value = media.language || '';
            document.getElementById('rating').value = media.rating || '';
            
            // Genres
            document.getElementById('genres').value = (media.genres && Array.isArray(media.genres)) ? media.genres.join(', ') : '';

            // Cast members
            try {
                document.getElementById('cast_members').value = JSON.stringify(media.cast_members || [], null, 2);
            } catch (e) {
                document.getElementById('cast_members').value = '[]';
            }

            const dynamicFieldsContainer = document.getElementById('dynamic-fields');
            dynamicFieldsContainer.innerHTML = '';

            if (media.type === 'movie') {
                dynamicFieldsContainer.innerHTML = `
                    <div class="form-section">
                        <h2>🔗 Video Links</h2>
                        <div class="form-group">
                            <label for="video_720p">720p Video URL:</label>
                            <input type="text" id="video_720p" name="video_720p" placeholder="https://example.com/video_720p.mp4">
                        </div>
                        <div class="form-group">
                            <label for="video_1080p">1080p Video URL:</label>
                            <input type="text" id="video_1080p" name="video_1080p" placeholder="https://example.com/video_1080p.mp4">
                        </div>
                        <div class="form-group">
                            <label for="video_2160p">2160p Video URL:</label>
                            <input type="text" id="video_2160p" name="video_2160p" placeholder="https://example.com/video_2160p.mp4">
                        </div>

                        <h2>⬇️ Download Links</h2>
                        <div class="form-group">
                            <label for="download_720p">720p Download URL:</label>
                            <input type="text" id="download_720p" name="download_720p" placeholder="https://example.com/download_720p.mp4">
                        </div>
                        <div class="form-group">
                            <label for="download_1080p">1080p Download URL:</label>
                            <input type="text" id="download_1080p" name="download_1080p" placeholder="https://example.com/download_1080p.mp4">
                        </div>
                        <div class="form-group">
                            <label for="download_2160p">2160p Download URL:</label>
                            <input type="text" id="download_2160p" name="download_2160p" placeholder="https://example.com/download_2160p.mp4">
                        </div>

                        <h2>🧲 Torrent Links</h2>
                        <div class="form-group">
                            <label for="torrent_720p">720p Torrent URL:</label>
                            <input type="text" id="torrent_720p" name="torrent_720p" placeholder="magnet:?xt=urn:btih:...">
                        </div>
                        <div class="form-group">
                            <label for="torrent_1080p">1080p Torrent URL:</label>
                            <input type="text" id="torrent_1080p" name="torrent_1080p" placeholder="magnet:?xt=urn:btih:...">
                        </div>
                        <div class="form-group">
                            <label for="torrent_2160p">2160p Torrent URL:</label>
                            <input type="text" id="torrent_2160p" name="torrent_2160p" placeholder="magnet:?xt=urn:btih:...">
                        </div>
                    </div>
                `;

                // Populate movie links
                if (media.video_links) {
                    document.getElementById('video_720p').value = media.video_links['720p'] || '';
                    document.getElementById('video_1080p').value = media.video_links['1080p'] || '';
                    document.getElementById('video_2160p').value = media.video_links['2160p'] || '';
                }

                if (media.download_links) {
                    document.getElementById('download_720p').value = media.download_links['720p']?.url || '';
                    document.getElementById('download_1080p').value = media.download_links['1080p']?.url || '';
                    document.getElementById('download_2160p').value = media.download_links['2160p']?.url || '';
                }

                if (media.torrent_links) {
                    document.getElementById('torrent_720p').value = media.torrent_links['720p'] || '';
                    document.getElementById('torrent_1080p').value = media.torrent_links['1080p'] || '';
                    document.getElementById('torrent_2160p').value = media.torrent_links['2160p'] || '';
                }

            } else if (media.type === 'tv') {
                dynamicFieldsContainer.innerHTML = `
                    <div class="form-section">
                        <h2>TV Series Details</h2>
                        <div class="form-group">
                            <label for="total_seasons">Total Seasons:</label>
                            <input type="number" id="total_seasons" name="total_seasons" value="${media.total_seasons || 0}">
                        </div>
                        
                        <h2>🔗 TV Series Video Links</h2>
                        <div class="form-group">
                            <label for="tv_video_720p">720p Video URL:</label>
                            <input type="text" id="tv_video_720p" name="tv_video_720p" placeholder="https://example.com/series_720p/">
                        </div>
                        <div class="form-group">
                            <label for="tv_video_1080p">1080p Video URL:</label>
                            <input type="text" id="tv_video_1080p" name="tv_video_1080p" placeholder="https://example.com/series_1080p/">
                        </div>
                        <div class="form-group">
                            <label for="tv_video_2160p">2160p Video URL:</label>
                            <input type="text" id="tv_video_2160p" name="tv_video_2160p" placeholder="https://example.com/series_2160p/">
                        </div>
                        
                        <div id="seasons-container"></div>
                        <button type="button" class="btn-secondary" onclick="addSeason()">Add New Season</button>
                    </div>
                `;
                
                // Populate TV series video links
                if (media.video_links) {
                    document.getElementById('tv_video_720p').value = media.video_links['720p'] || '';
                    document.getElementById('tv_video_1080p').value = media.video_links['1080p'] || '';
                    document.getElementById('tv_video_2160p').value = media.video_links['2160p'] || '';
                }
                
                // Populate seasons
                if (media.seasons && typeof media.seasons === 'object') {
                    const seasonKeys = Object.keys(media.seasons).sort((a, b) => {
                        const aNum = parseInt(a.split('_')[1]) || 0;
                        const bNum = parseInt(b.split('_')[1]) || 0;
                        return aNum - bNum;
                    });
                    seasonKeys.forEach(key => {
                        const season = media.seasons[key];
                        if (season) {
                            addSeason(season);
                        }
                    });
                }
            }
        }

        function addSeason(seasonData = null) {
            seasonNumberCounter++;
            const container = document.getElementById('seasons-container');
            const seasonDiv = document.createElement('div');
            seasonDiv.classList.add('season-container');
            const seasonNumber = seasonData ? seasonData.season_number : seasonNumberCounter;
            seasonDiv.innerHTML = `
                <h3>Season ${seasonNumber} <button type="button" class="remove-btn" onclick="removeSeason(this)">Remove</button></h3>
                <div class="form-group">
                    <label>Episodes</label>
                    <div class="episode-container" data-season-number="${seasonNumber}"></div>
                </div>
                <button type="button" class="btn-secondary" onclick="addEpisode(this)">+ Add Episode</button>
            `;
            container.appendChild(seasonDiv);
            
            if (seasonData && seasonData.episodes) {
                seasonData.episodes.forEach(episode => {
                    addEpisode(seasonDiv.querySelector('.btn-secondary'), episode);
                });
            }
        }

        function removeSeason(button) {
            if (confirm('Are you sure you want to remove this season and all its episodes?')) {
                button.closest('.season-container').remove();
            }
        }

        function addEpisode(button, episodeData = null) {
            const episodeContainer = button.previousElementSibling.querySelector('.episode-container');
            const seasonNumber = episodeContainer.dataset.seasonNumber;
            const episodeCount = episodeContainer.children.length + 1;
            const episodeDiv = document.createElement('div');
            episodeDiv.classList.add('episode-row');
            
            const episodeName = episodeData ? (episodeData.episode_name || '') : '';
            const video720p = episodeData ? (episodeData.video_720p || '') : '';
            const download720p = episodeData ? (episodeData.download_720p?.url || '') : '';
            const torrent720p = episodeData ? (episodeData.torrent_720p || '') : '';
            const video1080p = episodeData ? (episodeData.video_1080p || '') : '';
            const download1080p = episodeData ? (episodeData.download_1080p?.url || '') : '';
            const torrent1080p = episodeData ? (episodeData.torrent_1080p || '') : '';
            const video2160p = episodeData ? (episodeData.video_2160p || '') : '';
            const download2160p = episodeData ? (episodeData.download_2160p?.url || '') : '';
            const torrent2160p = episodeData ? (episodeData.torrent_2160p || '') : '';
            
            episodeDiv.innerHTML = `
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_name" placeholder="Episode Name" value="${episodeName}" required>
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_video_720p" placeholder="720p Video Link" value="${video720p}">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_download_720p" placeholder="720p Download Link" value="${download720p}">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_torrent_720p" placeholder="720p Torrent Link" value="${torrent720p}">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_video_1080p" placeholder="1080p Video Link" value="${video1080p}">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_download_1080p" placeholder="1080p Download Link" value="${download1080p}">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_torrent_1080p" placeholder="1080p Torrent Link" value="${torrent1080p}">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_video_2160p" placeholder="2160p Video Link" value="${video2160p}">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_download_2160p" placeholder="2160p Download Link" value="${download2160p}">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_torrent_2160p" placeholder="2160p Torrent Link" value="${torrent2160p}">
                <button type="button" class="remove-btn" onclick="removeEpisode(this)">Remove</button>
            `;
            episodeContainer.appendChild(episodeDiv);
        }

        function removeEpisode(button) {
            if (confirm('Are you sure you want to remove this episode?')) {
                button.closest('.episode-row').remove();
            }
        }

        // Enhanced form submission with debugging
        document.getElementById('edit-media-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const mediaId = document.getElementById('media-id').value;
            const mediaType = document.getElementById('type').value;

            // Add loading state
            form.classList.add('loading');
            const submitButton = form.querySelector('.btn-primary');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Updating...';

            // Basic validation
            if (!mediaId || !mediaType || !form.title.value.trim()) {
                alert('Media ID, type, and title are required.');
                form.classList.remove('loading');
                submitButton.textContent = originalText;
                return;
            }

            // Build data object
            const data = {
                type: mediaType,
                title: form.title.value.trim(),
                description: form.description.value.trim() || null,
                thumbnail: form.thumbnail.value.trim() || null,
                backdrop: form.backdrop.value.trim() || null,
                release_date: form.release_date.value || null,
                language: form.language.value.trim() || null,
                rating: form.rating.value ? parseFloat(form.rating.value) : null,
                genres: form.genres.value.trim() ? form.genres.value.split(',').map(g => g.trim()) : [],
                cast_members: JSON.parse(form.cast_members.value || '[]')
            };

            // Handle media type specific data
            if (mediaType === 'movie') {
                data.video_720p = document.getElementById('video_720p').value.trim();
                data.video_1080p = document.getElementById('video_1080p').value.trim();
                data.video_2160p = document.getElementById('video_2160p').value.trim();
                data.download_720p = document.getElementById('download_720p').value.trim();
                data.download_1080p = document.getElementById('download_1080p').value.trim();
                data.download_2160p = document.getElementById('download_2160p').value.trim();
                data.torrent_720p = document.getElementById('torrent_720p').value.trim();
                data.torrent_1080p = document.getElementById('torrent_1080p').value.trim();
                data.torrent_2160p = document.getElementById('torrent_2160p').value.trim();

                data.total_seasons = null;
                data.seasons = null;

            } else if (mediaType === 'tv') {
                data.tv_video_720p = document.getElementById('tv_video_720p').value.trim();
                data.tv_video_1080p = document.getElementById('tv_video_1080p').value.trim();
                data.tv_video_2160p = document.getElementById('tv_video_2160p').value.trim();

                // Process seasons and episodes
                const seasons = {};
                const seasonContainers = document.querySelectorAll('.season-container');
                
                seasonContainers.forEach((seasonDiv, index) => {
                    const seasonNumber = index + 1;
                    const episodes = [];
                    const episodeRows = seasonDiv.querySelectorAll('.episode-row');
                    
                    episodeRows.forEach((row, epIndex) => {
                        const episodeNumber = epIndex + 1;
                        const episodeName = row.querySelector(`input[placeholder="Episode Name"]`).value.trim();
                        
                        if (episodeName) {
                            episodes.push({
                                episode_number: episodeNumber,
                                episode_name: episodeName,
                                video_720p: row.querySelector(`input[placeholder="720p Video Link"]`).value.trim() || null,
                                download_720p: row.querySelector(`input[placeholder="720p Download Link"]`).value.trim() ? 
                                    { url: row.querySelector(`input[placeholder="720p Download Link"]`).value.trim(), file_type: 'webrip' } : null,
                                torrent_720p: row.querySelector(`input[placeholder="720p Torrent Link"]`).value.trim() || null,
                                video_1080p: row.querySelector(`input[placeholder="1080p Video Link"]`).value.trim() || null,
                                download_1080p: row.querySelector(`input[placeholder="1080p Download Link"]`).value.trim() ? 
                                    { url: row.querySelector(`input[placeholder="1080p Download Link"]`).value.trim(), file_type: 'webrip' } : null,
                                torrent_1080p: row.querySelector(`input[placeholder="1080p Torrent Link"]`).value.trim() || null,
                                video_2160p: row.querySelector(`input[placeholder="2160p Video Link"]`).value.trim() || null,
                                download_2160p: row.querySelector(`input[placeholder="2160p Download Link"]`).value.trim() ? 
                                    { url: row.querySelector(`input[placeholder="2160p Download Link"]`).value.trim(), file_type: 'webrip' } : null,
                                torrent_2160p: row.querySelector(`input[placeholder="2160p Torrent Link"]`).value.trim() || null
                            });
                        }
                    });

                    if (episodes.length > 0) {
                        seasons[`season_${seasonNumber}`] = {
                            season_number: seasonNumber,
                            total_episodes: episodes.length,
                            episodes: episodes
                        };
                    }
                });

                data.total_seasons = Object.keys(seasons).length;
                data.seasons = Object.keys(seasons).length > 0 ? seasons : null;
            }

            // Debug: Show the data being sent
            console.log('Sending data:', data);
            document.getElementById('debug-info').style.display = 'block';
            document.getElementById('debug-info').textContent = 'Sending data: ' + JSON.stringify(data, null, 2);

            try {
                const response = await fetch(`${ADMIN_API_BASE_URL}/media/${mediaId}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': AUTH_HEADER 
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                console.log('Server response:', result);

                if (response.ok) {
                    document.getElementById('success-message').style.display = 'block';
                    document.getElementById('success-message').textContent = 'Media updated successfully!';
                    setTimeout(() => {
                        window.location.href = '/admin/search_and_edit';
                    }, 1500);
                } else {
                    alert(`Error ${response.status}: ${result.message || 'Unknown error'}`);
                }
            } catch (err) {
                console.error('Request failed:', err);
                alert('Network error: Unable to connect to server. Please check your connection and try again.');
            } finally {
                form.classList.remove('loading');
                submitButton.textContent = originalText;
            }
        });
    </script>
</body>
</html>
