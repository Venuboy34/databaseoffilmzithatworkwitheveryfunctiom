<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Media</title>
    <style>
        /* Your existing CSS remains the same */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1c1c1e;
            color: #f0f0f0;
            padding: 20px;
            margin: 0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 900px;
            margin: 40px auto;
            background: #2c2c2e;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
        }

        .form-section {
            background: #3a3a3c;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #b0b0b0;
        }

        input[type="text"], input[type="number"], input[type="date"], select, textarea {
            width: 100%;
            padding: 12px;
            box-sizing: border-box;
            background: #4a4a4c;
            border: 1px solid #555;
            color: #fff;
            border-radius: 6px;
        }

        .btn-primary {
            background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%);
            color: #fff;
            width: 100%;
            margin-top: 20px;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        /* TV Series Specific Styles */
        .season-container {
            border: 1px dashed #555;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            background-color: #2c2c2e;
        }
        
        .episode-container {
            margin-top: 15px;
            padding-left: 20px;
            border-left: 2px solid #6a11cb;
        }

        .episode-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .episode-row input {
            flex-grow: 1;
            min-width: 150px;
        }

        .btn-secondary {
            background-color: #555;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }

        .remove-btn {
            background: #ff4d4d;
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>✏️ Edit Media</h1>
        
        <div id="loading-error" class="error-message" style="display: none;">
            Error: Cannot load media. Please ensure the ID is valid and the backend is running.
        </div>

        <div id="success-message" class="success-message" style="display: none;"></div>
        
        <form id="edit-media-form">
            <input type="hidden" id="media-id" name="id">
            
            <div class="form-section">
                <h2>Media Details</h2>
                <div class="form-group">
                    <label for="type">Media Type:</label>
                    <input type="text" id="type" name="type" readonly>
                </div>
                <div class="form-group">
                    <label for="title">Title: *</label>
                    <input type="text" id="title" name="title" required>
                </div>
                <div class="form-group">
                    <label for="description">Description:</label>
                    <textarea id="description" name="description" placeholder="Enter description..."></textarea>
                </div>
                <div class="form-group">
                    <label for="thumbnail">Thumbnail URL:</label>
                    <input type="text" id="thumbnail" name="thumbnail" placeholder="https://example.com/poster.jpg">
                </div>
                <div class="form-group">
                    <label for="backdrop">Backdrop Image URL:</label>
                    <input type="text" id="backdrop" name="backdrop" placeholder="https://example.com/backdrop.jpg">
                </div>
                <div class="form-group">
                    <label for="release_date">Release Date:</label>
                    <input type="date" id="release_date" name="release_date">
                </div>
                <div class="form-group">
                    <label for="language">Language:</label>
                    <input type="text" id="language" name="language" placeholder="en">
                </div>
                <div class="form-group">
                    <label for="rating">Rating:</label>
                    <input type="number" step="0.1" id="rating" name="rating" placeholder="7.5" min="0" max="10">
                </div>
                
                <div class="form-group">
                    <label for="file_type">File Type:</label>
                    <select id="file_type" name="file_type">
                        <option value="webrip">WebRip</option>
                        <option value="bluray">BluRay</option>
                        <option value="webdl">WebDL</option>
                        <option value="hdtv">HDTV</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="genres">Genres (comma-separated):</label>
                    <input type="text" id="genres" name="genres" placeholder="Action, Drama, Comedy">
                </div>
                <div class="form-group">
                    <label for="cast_members">Cast (JSON):</label>
                    <textarea id="cast_members" name="cast_members" placeholder='[{"name": "Actor Name", "character": "Character Name"}]'></textarea>
                </div>
            </div>
            
            <div id="dynamic-fields"></div>

            <button type="submit" class="btn-primary">Update Media</button>
        </form>
    </div>

    <script>
        const API_BASE_URL = window.location.origin + '/api/media';
        const ADMIN_API_BASE_URL = window.location.origin + '/api/admin';
        const AUTH_HEADER = 'Basic ' + btoa('venura:venura');
        let seasonNumberCounter = 0;

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const mediaId = urlParams.get('id');
            if (!mediaId) {
                document.getElementById('loading-error').style.display = 'block';
                return;
            }
            document.getElementById('media-id').value = mediaId;
            await loadMediaData(mediaId);
        });

        async function loadMediaData(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/${id}`);
                if (!response.ok) {
                    throw new Error('Media not found.');
                }
                const media = await response.json();
                console.log('Loaded media data:', media);
                
                // Parse JSON strings if needed
                if (typeof media.video_links === 'string') {
                    try {
                        media.video_links = JSON.parse(media.video_links);
                    } catch (e) {
                        media.video_links = {};
                    }
                }
                
                if (typeof media.download_links === 'string') {
                    try {
                        media.download_links = JSON.parse(media.download_links);
                    } catch (e) {
                        media.download_links = {};
                    }
                }
                
                if (typeof media.torrent_links === 'string') {
                    try {
                        media.torrent_links = JSON.parse(media.torrent_links);
                    } catch (e) {
                        media.torrent_links = {};
                    }
                }
                
                if (typeof media.cast_members === 'string') {
                    try {
                        media.cast_members = JSON.parse(media.cast_members);
                    } catch (e) {
                        media.cast_members = [];
                    }
                }
                
                if (typeof media.genres === 'string') {
                    try {
                        media.genres = JSON.parse(media.genres);
                    } catch (e) {
                        media.genres = [];
                    }
                }
                
                if (typeof media.seasons === 'string') {
                    try {
                        media.seasons = JSON.parse(media.seasons);
                    } catch (e) {
                        media.seasons = null;
                    }
                }
                
                populateForm(media);
            } catch (err) {
                console.error("Failed to load media:", err);
                document.getElementById('loading-error').style.display = 'block';
            }
        }

        function populateForm(media) {
            console.log('Populating form with:', media);
            
            // Basic fields
            document.getElementById('type').value = media.type || '';
            document.getElementById('title').value = media.title || '';
            document.getElementById('description').value = media.description || '';
            document.getElementById('thumbnail').value = media.thumbnail || '';
            document.getElementById('backdrop').value = media.backdrop || '';
            document.getElementById('release_date').value = media.release_date || '';
            document.getElementById('language').value = media.language || '';
            document.getElementById('rating').value = media.rating || '';
            document.getElementById('file_type').value = media.file_type || 'webrip';
            
            // Genres
            document.getElementById('genres').value = (media.genres && Array.isArray(media.genres)) ? media.genres.join(', ') : '';

            // Cast members
            try {
                document.getElementById('cast_members').value = JSON.stringify(media.cast_members || [], null, 2);
            } catch (e) {
                document.getElementById('cast_members').value = '[]';
            }

            const dynamicFieldsContainer = document.getElementById('dynamic-fields');
            dynamicFieldsContainer.innerHTML = '';

            if (media.type === 'movie') {
                // Extract video links
                let video720 = '';
                let video1080 = '';
                let video2160 = '';
                
                if (media.video_links && typeof media.video_links === 'object') {
                    video720 = media.video_links['video_720p'] || '';
                    video1080 = media.video_links['video_1080p'] || '';
                    video2160 = media.video_links['video_2160p'] || '';
                }
                
                // Extract download links - handle nested objects
                let download720 = '';
                let download1080 = '';
                let download2160 = '';
                
                if (media.download_links && typeof media.download_links === 'object') {
                    // Handle nested object structure: {"download_720p": {"url": "https://...", "file_type": "webrip"}}
                    const dl720 = media.download_links['download_720p'];
                    const dl1080 = media.download_links['download_1080p'];
                    const dl2160 = media.download_links['download_2160p'];
                    
                    download720 = (dl720 && dl720.url) ? dl720.url : '';
                    download1080 = (dl1080 && dl1080.url) ? dl1080.url : '';
                    download2160 = (dl2160 && dl2160.url) ? dl2160.url : '';
                }
                
                // Extract torrent links
                let torrent720 = '';
                let torrent1080 = '';
                let torrent2160 = '';
                
                if (media.torrent_links && typeof media.torrent_links === 'object') {
                    torrent720 = media.torrent_links['torrent_720p'] || '';
                    torrent1080 = media.torrent_links['torrent_1080p'] || '';
                    torrent2160 = media.torrent_links['torrent_2160p'] || '';
                }
                
                dynamicFieldsContainer.innerHTML = `
                    <div class="form-section">
                        <h2>🔗 Video Links</h2>
                        <div class="form-group">
                            <label for="video_720p">720p Video URL:</label>
                            <input type="text" id="video_720p" name="video_720p" placeholder="https://example.com/video_720p.mp4" value="${video720}">
                        </div>
                        <div class="form-group">
                            <label for="video_1080p">1080p Video URL:</label>
                            <input type="text" id="video_1080p" name="video_1080p" placeholder="https://example.com/video_1080p.mp4" value="${video1080}">
                        </div>
                        <div class="form-group">
                            <label for="video_2160p">2160p Video URL:</label>
                            <input type="text" id="video_2160p" name="video_2160p" placeholder="https://example.com/video_2160p.mp4" value="${video2160}">
                        </div>

                        <h2>⬇️ Download Links</h2>
                        <div class="form-group">
                            <label for="download_720p">720p Download URL:</label>
                            <input type="text" id="download_720p" name="download_720p" placeholder="https://example.com/download_720p.mp4" value="${download720}">
                        </div>
                        <div class="form-group">
                            <label for="download_1080p">1080p Download URL:</label>
                            <input type="text" id="download_1080p" name="download_1080p" placeholder="https://example.com/download_1080p.mp4" value="${download1080}">
                        </div>
                        <div class="form-group">
                            <label for="download_2160p">2160p Download URL:</label>
                            <input type="text" id="download_2160p" name="download_2160p" placeholder="https://example.com/download_2160p.mp4" value="${download2160}">
                        </div>

                        <h2>🧲 Torrent Links</h2>
                        <div class="form-group">
                            <label for="torrent_720p">720p Torrent URL:</label>
                            <input type="text" id="torrent_720p" name="torrent_720p" placeholder="magnet:?xt=urn:btih:..." value="${torrent720}">
                        </div>
                        <div class="form-group">
                            <label for="torrent_1080p">1080p Torrent URL:</label>
                            <input type="text" id="torrent_1080p" name="torrent_1080p" placeholder="magnet:?xt=urn:btih:..." value="${torrent1080}">
                        </div>
                        <div class="form-group">
                            <label for="torrent_2160p">2160p Torrent URL:</label>
                            <input type="text" id="torrent_2160p" name="torrent_2160p" placeholder="magnet:?xt=urn:btih:..." value="${torrent2160}">
                        </div>
                    </div>
                `;
            } else if (media.type === 'tv') {
                // Get TV series video links
                const tvVideo720 = media.video_links ? (media.video_links['video_720p'] || '') : '';
                const tvVideo1080 = media.video_links ? (media.video_links['video_1080p'] || '') : '';
                const tvVideo2160 = media.video_links ? (media.video_links['video_2160p'] || '') : '';
                
                dynamicFieldsContainer.innerHTML = `
                    <div class="form-section">
                        <h2>TV Series Details</h2>
                        <div class="form-group">
                            <label for="total_seasons">Total Seasons:</label>
                            <input type="number" id="total_seasons" name="total_seasons" value="${media.total_seasons || 0}">
                        </div>
                        
                        <h2>🔗 TV Series Video Links</h2>
                        <div class="form-group">
                            <label for="tv_video_720p">720p Video URL:</label>
                            <input type="text" id="tv_video_720p" name="tv_video_720p" placeholder="https://example.com/series_720p/" value="${tvVideo720}">
                        </div>
                        <div class="form-group">
                            <label for="tv_video_1080p">1080p Video URL:</label>
                            <input type="text" id="tv_video_1080p" name="tv_video_1080p" placeholder="https://example.com/series_1080p/" value="${tvVideo1080}">
                        </div>
                        <div class="form-group">
                            <label for="tv_video_2160p">2160p Video URL:</label>
                            <input type="text" id="tv_video_2160p" name="tv_video_2160p" placeholder="https://example.com/series_2160p/" value="${tvVideo2160}">
                        </div>
                        
                        <div id="seasons-container"></div>
                        <button type="button" class="btn-secondary" onclick="addSeason()">Add New Season</button>
                    </div>
                `;
                
                // Populate seasons after a brief delay
                setTimeout(() => {
                    if (media.seasons && typeof media.seasons === 'object') {
                        const seasonKeys = Object.keys(media.seasons).sort((a, b) => {
                            const aNum = parseInt(a.split('_')[1]) || 0;
                            const bNum = parseInt(b.split('_')[1]) || 0;
                            return aNum - bNum;
                        });
                        seasonKeys.forEach(key => {
                            const season = media.seasons[key];
                            if (season) {
                                addSeason(season);
                            }
                        });
                    }
                    console.log('TV links populated successfully');
                }, 50);
            }
        }

        function addSeason(seasonData = null) {
            seasonNumberCounter++;
            const container = document.getElementById('seasons-container');
            const seasonDiv = document.createElement('div');
            seasonDiv.classList.add('season-container');
            const seasonNumber = seasonData ? seasonData.season_number : seasonNumberCounter;
            seasonDiv.innerHTML = `
                <h3>Season ${seasonNumber} <button type="button" class="remove-btn" onclick="removeSeason(this)">Remove</button></h3>
                <div class="form-group">
                    <label>Episodes</label>
                    <div class="episode-container" data-season-number="${seasonNumber}"></div>
                </div>
                <button type="button" class="btn-secondary" onclick="addEpisode(this)">+ Add Episode</button>
            `;
            container.appendChild(seasonDiv);
            
            if (seasonData && seasonData.episodes) {
                seasonData.episodes.forEach(episode => {
                    addEpisode(seasonDiv.querySelector('.btn-secondary'), episode);
                });
            }
        }

        function removeSeason(button) {
            if (confirm('Are you sure you want to remove this season and all its episodes?')) {
                button.closest('.season-container').remove();
            }
        }

        function addEpisode(button, episodeData = null) {
            const episodeContainer = button.previousElementSibling.querySelector('.episode-container');
            const seasonNumber = episodeContainer.dataset.seasonNumber;
            const episodeCount = episodeContainer.children.length + 1;
            const episodeDiv = document.createElement('div');
            episodeDiv.classList.add('episode-row');
            
            const episodeName = episodeData ? (episodeData.episode_name || '') : '';
            const video720p = episodeData ? (episodeData.video_720p || '') : '';
            const video1080p = episodeData ? (episodeData.video_1080p || '') : '';
            const video2160p = episodeData ? (episodeData.video_2160p || '') : '';
            
            // Handle download links properly - check for both object and string formats
            let download720p = '';
            let download1080p = '';
            let download2160p = '';
            
            if (episodeData) {
                const dl720 = episodeData.download_720p;
                const dl1080 = episodeData.download_1080p;
                const dl2160 = episodeData.download_2160p;
                
                download720p = (typeof dl720 === 'object' && dl720 !== null) ? dl720.url : (dl720 || '');
                download1080p = (typeof dl1080 === 'object' && dl1080 !== null) ? dl1080.url : (dl1080 || '');
                download2160p = (typeof dl2160 === 'object' && dl2160 !== null) ? dl2160.url : (dl2160 || '');
            }
            
            const torrent720p = episodeData ? (episodeData.torrent_720p || '') : '';
            const torrent1080p = episodeData ? (episodeData.torrent_1080p || '') : '';
            const torrent2160p = episodeData ? (episodeData.torrent_2160p || '') : '';
            
            episodeDiv.innerHTML = `
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_name" placeholder="Episode Name" value="${episodeName}" required style="flex-basis: 100%;">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_video_720p" placeholder="720p Video Link" value="${video720p}">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_download_720p" placeholder="720p Download Link" value="${download720p}">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_torrent_720p" placeholder="720p Torrent Link" value="${torrent720p}">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_video_1080p" placeholder="1080p Video Link" value="${video1080p}">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_download_1080p" placeholder="1080p Download Link" value="${download1080p}">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_torrent_1080p" placeholder="1080p Torrent Link" value="${torrent1080p}">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_video_2160p" placeholder="2160p Video Link" value="${video2160p}">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_download_2160p" placeholder="2160p Download Link" value="${download2160p}">
                <input type="text" name="season_${seasonNumber}_episode_${episodeCount}_torrent_2160p" placeholder="2160p Torrent Link" value="${torrent2160p}">
                <button type="button" class="remove-btn" onclick="removeEpisode(this)">Remove</button>
            `;
            episodeContainer.appendChild(episodeDiv);
        }

        function removeEpisode(button) {
            if (confirm('Are you sure you want to remove this episode?')) {
                button.closest('.episode-row').remove();
            }
        }

        document.getElementById('edit-media-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const mediaId = document.getElementById('media-id').value;
            const mediaType = document.getElementById('type').value;
            const fileType = document.getElementById('file_type').value;

            // Add loading state
            const submitButton = form.querySelector('.btn-primary');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Updating...';

            // Build data object
            const data = {
                type: mediaType,
                title: form.title.value.trim(),
                description: form.description.value.trim() || null,
                thumbnail: form.thumbnail.value.trim() || null,
                backdrop: form.backdrop.value.trim() || null,
                release_date: form.release_date.value || null,
                language: form.language.value.trim() || null,
                rating: form.rating.value ? parseFloat(form.rating.value) : null,
                file_type: fileType,
                genres: form.genres.value.trim() ? form.genres.value.split(',').map(g => g.trim()) : [],
                cast_members: JSON.parse(form.cast_members.value || '[]')
            };

            if (mediaType === 'movie') {
                // Video links as direct URLs
                const v720Val = document.getElementById('video_720p').value.trim();
                const v1080Val = document.getElementById('video_1080p').value.trim();
                const v2160Val = document.getElementById('video_2160p').value.trim();
                
                data.video_720p = v720Val || null;
                data.video_1080p = v1080Val || null;
                data.video_2160p = v2160Val || null;
                
                // Download links as NESTED OBJECTS (matches your database)
                const dl720Val = document.getElementById('download_720p').value.trim();
                const dl1080Val = document.getElementById('download_1080p').value.trim();
                const dl2160Val = document.getElementById('download_2160p').value.trim();
                
                data.download_720p = dl720Val || null;
                data.download_1080p = dl1080Val || null;
                data.download_2160p = dl2160Val || null;
                
                // Torrent links as direct URLs
                const t720Val = document.getElementById('torrent_720p').value.trim();
                const t1080Val = document.getElementById('torrent_1080p').value.trim();
                const t2160Val = document.getElementById('torrent_2160p').value.trim();
                
                data.torrent_720p = t720Val || null;
                data.torrent_1080p = t1080Val || null;
                data.torrent_2160p = t2160Val || null;
            } else if (mediaType === 'tv') {
                // Get TV series video links
                const tv720 = document.getElementById('tv_video_720p') ? document.getElementById('tv_video_720p').value.trim() : null;
                const tv1080 = document.getElementById('tv_video_1080p') ? document.getElementById('tv_video_1080p').value.trim() : null;
                const tv2160 = document.getElementById('tv_video_2160p') ? document.getElementById('tv_video_2160p').value.trim() : null;
                
                data.video_720p = tv720 || null;
                data.video_1080p = tv1080 || null;
                data.video_2160p = tv2160 || null;

                // Process seasons and episodes
                const seasons = {};
                const seasonContainers = document.querySelectorAll('.season-container');
                
                seasonContainers.forEach((seasonDiv, index) => {
                    const seasonNumber = index + 1;
                    const episodes = [];
                    const episodeRows = seasonDiv.querySelectorAll('.episode-row');
                    
                    episodeRows.forEach((row, epIndex) => {
                        const episodeNumber = epIndex + 1;
                        const episodeName = row.querySelector(`input[placeholder="Episode Name"]`).value.trim();
                        
                        if (episodeName) {
                            const dl720Val = row.querySelector(`input[placeholder="720p Download Link"]`).value.trim();
                            const dl1080Val = row.querySelector(`input[placeholder="1080p Download Link"]`).value.trim();
                            const dl2160Val = row.querySelector(`input[placeholder="2160p Download Link"]`).value.trim();
                            
                            episodes.push({
                                episode_number: episodeNumber,
                                episode_name: episodeName,
                                video_720p: row.querySelector(`input[placeholder="720p Video Link"]`).value.trim() || null,
                                download_720p: dl720Val ? { url: dl720Val, file_type: fileType } : null,
                                torrent_720p: row.querySelector(`input[placeholder="720p Torrent Link"]`).value.trim() || null,
                                video_1080p: row.querySelector(`input[placeholder="1080p Video Link"]`).value.trim() || null,
                                download_1080p: dl1080Val ? { url: dl1080Val, file_type: fileType } : null,
                                torrent_1080p: row.querySelector(`input[placeholder="1080p Torrent Link"]`).value.trim() || null,
                                video_2160p: row.querySelector(`input[placeholder="2160p Video Link"]`).value.trim() || null,
                                download_2160p: dl2160Val ? { url: dl2160Val, file_type: fileType } : null,
                                torrent_2160p: row.querySelector(`input[placeholder="2160p Torrent Link"]`).value.trim() || null
                            });
                        }
                    });

                    if (episodes.length > 0) {
                        seasons[`season_${seasonNumber}`] = {
                            season_number: seasonNumber,
                            total_episodes: episodes.length,
                            episodes: episodes
                        };
                    }
                });

                data.total_seasons = Object.keys(seasons).length;
                data.seasons = Object.keys(seasons).length > 0 ? seasons : null;
            }

            try {
                const response = await fetch(`${ADMIN_API_BASE_URL}/media/${mediaId}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': AUTH_HEADER 
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                console.log('Server response:', result);

                if (response.ok) {
                    const successMsg = document.getElementById('success-message');
                    successMsg.style.display = 'block';
                    successMsg.textContent = '✅ Media updated successfully!';
                    
                    setTimeout(() => {
                        window.location.href = '/admin/search_and_edit';
                    }, 2000);
                } else {
                    alert(`Error: ${result.message || 'Unknown error'}`);
                }
            } catch (err) {
                console.error('Request failed:', err);
                alert('Network error: Unable to connect to server.');
            } finally {
                submitButton.textContent = originalText;
            }
        });
    </script>
</body>
</html>
