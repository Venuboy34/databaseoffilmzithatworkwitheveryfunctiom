<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Episode</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; background: #282c34; color: #fff;}
        h1 { text-align: center; color: #fff;}
        form div { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #fff;}
        input[type="text"], input[type="number"], textarea { width: 100%; padding: 8px; box-sizing: border-box; background: #4a505b; border: 1px solid #555; color: #fff; border-radius: 5px;}
        textarea { height: 100px; }
        .button-group { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;}
        button { padding: 10px 15px; cursor: pointer; background: #6a11cb; color: #fff; border: none; border-radius: 5px; font-size: 16px;}
        button:hover { background: #2575fc; }
        a {
            display: inline-block;
            padding: 10px 15px;
            background: #555;
            color: #fff;
            text-decoration: none;
            border-radius: 5px;
            font-size: 16px;
            text-align: center;
        }
        a:hover { background: #666; }
    </style>
</head>
<body>
    <h1>Add Episode for "{{ media.title }}"</h1>
    <form id="add-episode-form">
        <div>
            <label for="season_number">Season Number:</label>
            <input type="number" id="season_number" name="season_number" required>
        </div>
        <div>
            <label for="episode_number">Episode Number:</label>
            <input type="number" id="episode_number" name="episode_number" required>
        </div>
        <div>
            <label for="episode_name">Episode Name:</label>
            <input type="text" id="episode_name" name="episode_name" required>
        </div>
        
        <div>
            <label for="video_1080p">1080p Video Link:</label>
            <input type="text" id="video_1080p" name="video_1080p">
        </div>
        <div>
            <label for="video_2160p">2160p Video Link:</label>
            <input type="text" id="video_2160p" name="video_2160p">
        </div>

        <div>
            <label for="download_1080p">1080p Download Link:</label>
            <input type="text" id="download_1080p" name="download_1080p">
        </div>
        <div>
            <label for="download_2160p">2160p Download Link:</label>
            <input type="text" id="download_2160p" name="download_2160p">
        </div>

        <div>
            <label for="torrent_1080p">1080p Torrent Link:</label>
            <input type="text" id="torrent_1080p" name="torrent_1080p" placeholder="magnet:?xt=urn:btih:...">
        </div>
        <div>
            <label for="torrent_2160p">2160p Torrent Link:</label>
            <input type="text" id="torrent_2160p" name="torrent_2160p" placeholder="magnet:?xt=urn:btih:...">
        </div>

        <div class="button-group">
            <button type="submit">Save Episode</button>
            <a href="/admin/search_and_edit">Cancel</a>
        </div>
    </form>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Extract media ID from the URL
            const urlParams = new URLSearchParams(window.location.search);
            const mediaId = urlParams.get('media_id');
            if (!mediaId) {
                alert('Media ID not found in URL.');
                return;
            }

            document.getElementById('add-episode-form').addEventListener('submit', async function(event) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);

                const videoLinks = {};
                if (formData.get('video_1080p')) videoLinks['1080p'] = formData.get('video_1080p');
                if (formData.get('video_2160p')) videoLinks['2160p'] = formData.get('video_2160p');

                const downloadLinks = {};
                if (formData.get('download_1080p')) downloadLinks['1080p'] = { url: formData.get('download_1080p'), file_type: 'webrip' };
                if (formData.get('download_2160p')) downloadLinks['2160p'] = { url: formData.get('download_2160p'), file_type: 'webrip' };

                const torrentLinks = {};
                if (formData.get('torrent_1080p')) torrentLinks['1080p'] = formData.get('torrent_1080p');
                if (formData.get('torrent_2160p')) torrentLinks['2160p'] = formData.get('torrent_2160p');

                const data = {
                    season_number: parseInt(formData.get('season_number')),
                    episode_number: parseInt(formData.get('episode_number')),
                    episode_name: formData.get('episode_name'),
                    video_links: videoLinks,
                    download_links: downloadLinks,
                    torrent_links: torrentLinks
                };

                try {
                    const response = await fetch(`/api/admin/media/${mediaId}/episode`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Basic ' + btoa('venura:venura')
                        },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();
                    if (response.ok) {
                        alert('Episode saved successfully!');
                        window.location.href = `/admin/edit?id=${mediaId}`;
                    } else {
                        alert('Error: ' + result.message);
                    }
                } catch (error) {
                    alert('An unexpected error occurred: ' + error.message);
                }
            });
        });
    </script>
</body>
</html>
